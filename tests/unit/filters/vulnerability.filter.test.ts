import { VulnerabilityFilter } from '../../../src/filters/vulnerability.filter';
import { Graph } from '../../../src/models/graph.model';
import { Node, Edge, Route } from '../../../src/types/graph.types';

describe('VulnerabilityFilter', () => {
  let filter: VulnerabilityFilter;
  let graph: Graph;

  beforeEach(() => {
    filter = new VulnerabilityFilter();
    
    const nodes: Node[] = [
      {
        name: 'vulnerable1',
        kind: 'service',
        vulnerabilities: [
          {
            file: 'test1.java',
            severity: 'high',
            message: 'Test vulnerability 1',
            metadata: {},
          },
        ],
      },
      {
        name: 'vulnerable2',
        kind: 'service',
        vulnerabilities: [
          {
            file: 'test2.java',
            severity: 'medium',
            message: 'Test vulnerability 2',
            metadata: {},
          },
        ],
      },
      { name: 'safe1', kind: 'service' },
      { name: 'safe2', kind: 'service' },
    ];

    const edges: Edge[] = [
      { from: 'vulnerable1', to: 'safe1' },
      { from: 'safe1', to: 'safe2' },
      { from: 'safe2', to: 'vulnerable2' },
    ];

    graph = new Graph(nodes, edges);
  });

  describe('apply', () => {
    it('should filter routes containing vulnerable nodes', () => {
      const routes: Route[] = [
        { path: ['vulnerable1', 'safe1'], length: 2 },
        { path: ['safe1', 'safe2'], length: 2 },
        { path: ['safe2', 'vulnerable2'], length: 2 },
      ];

      const filtered = filter.apply(routes, graph);

      expect(filtered).toHaveLength(2);
      expect(filtered.some(r => r.path.includes('vulnerable1'))).toBe(true);
      expect(filtered.some(r => r.path.includes('vulnerable2'))).toBe(true);
    });

    it('should return empty array if no routes contain vulnerabilities', () => {
      const routes: Route[] = [
        { path: ['safe1', 'safe2'], length: 2 },
      ];

      const filtered = filter.apply(routes, graph);
      expect(filtered).toHaveLength(0);
    });

    it('should include routes where vulnerability is in the middle', () => {
      const routes: Route[] = [
        { path: ['safe1', 'vulnerable1', 'safe2'], length: 3 },
      ];

      const filtered = filter.apply(routes, graph);
      expect(filtered).toHaveLength(1);
    });

    it('should handle empty routes array', () => {
      const filtered = filter.apply([], graph);
      expect(filtered).toHaveLength(0);
    });

    it('should handle routes with multiple vulnerable nodes', () => {
      const routes: Route[] = [
        { path: ['vulnerable1', 'safe1', 'vulnerable2'], length: 3 },
      ];

      const filtered = filter.apply(routes, graph);
      expect(filtered).toHaveLength(1);
    });
  });

  describe('name', () => {
    it('should have correct filter name', () => {
      expect(filter.name).toBe('hasVulnerability');
    });
  });
});
